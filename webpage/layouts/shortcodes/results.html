{{ $type := default "Tasks" (.Get "type") }}
{{ $fields := slice "submission_name" "embedding_name" }}
{{ $leaderboard := slice "leaderboard_task_name"}}
{{ $fieldsValue := slice  "embedding_name" }}
{{ $metrics := slice }}
{{ $metricsToIgnore := slice "classes" }}
{{ range $.Site.Data.results }}
   {{ range $k, $v := .metrics_avg }}
      {{if (not (in $metricsToIgnore $k)) }}
         {{ $metrics = uniq ($metrics | append $k) }}
      {{end}}
   {{ end }}
{{ end }}
{{ $fields :=  $fields | uniq }}

{{ $datasets := slice }}
{{ range $file, $result := $.Site.Data.results }}
    {{if or (eq $type "Tasks") (eq (index $result $leaderboard) $type)}}
        {{ $datasets = uniq ($datasets | append (index $result "dataset_name")) }}
    {{end}}
{{end}}

<style scoped>
      #data-table{
        max-width: 100vw;
        overflow: auto; 
      }
      .title {
        font-size: 32px;
        font-weight: 300;
        margin: 0.5em 0 1.5em 0;
        text-align: center;
      }
      .tabulator-cell{
         min-width: 75px !important;
         padding: 0.5em 0.2em !important;

      }
      .tabulator-col{
         min-width: 75px !important;
      }
      .tabulator-col-content{
         padding: 0.7em 0.5em !important;
         font-weight: 700;
         color: royalblue;
         font-size: 12px;
      }
      .title-container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        color: #6e6e6e;
        max-width: 90% !important;
      }
      .tabulator-col-title-holder{
         height: 100%;
      }
      .tabulator-col-title{
         display: flex;
         align-items: center;
         height: 100%;
         white-space: normal !important;
      }
      .tabulator-col-resize-handle.prev{
         border-left: 1px solid rgb(222, 226, 230);
      }
      .button{
         background: white;
         height: 20px;
         width: 20px;
         margin: 0px;
         padding: 0;
         font-size: 14px;
         font-weight: 600;
         background: royalblue;
         color: white;
         border: none;
         line-height: 15px;
         align-items: center !important;
         border-width: 1px;
         border-radius: 50% !important;
      }
      .button:hover{
         color: #f5e7bd;
         box-shadow: 0 1px 4px rgb(0 0 0);
      }
</style>
<input type="hidden" id="datasets-list" value="{{$datasets}}">
<div style="margin: 0 2em;">
   <div class="container title-container">     
      <div class="title">{{ $type }}</div>
</div>
<div id="content">
   {{ range $index, $dataset := $datasets }}
   <div>
      <table id="data-table-{{$index}}" >
         <thead>
            <tr>
               {{ range $field := $fields }}
                  <th>
                     {{ $field  | humanize  }}
                  </th>  
               {{end}}

               {{ range $metric := $metrics }}
                  {{ if and (ne $metric "f1_weighted") (ne $metric "recall_weighted") (ne $metric "precision_weighted")}}       
                     <th>
                        {{ $metric  |  humanize  }}
                     </th>
                  {{end}} 
               {{end}}
            </tr>
         </thead>
      {{ range $file, $result := $.Site.Data.results }}
      {{if or (eq $type "Tasks") (eq (index $result $leaderboard) $type)}}
            {{if eq (index $result "dataset_name") $dataset }}
               <div>
                  <tr>
                     {{ range $field:= $fields }}
                     <td>
                        {{if (eq $field "submission_name")}}
                           <button type="button" class="button" data-bs-toggle="modal" data-bs-target="#{{$file}}"> 
                              i
                           </button>
                           {{end}}
                           
                           {{if (in $fieldsValue $field)}}
                              {{ index $result $field "value"}}
                           {{else}}
                              {{ index $result $field }}
                           {{end}}
                     </td>
                     {{ end }}

                     {{ range $metric:= $metrics }}
                     <td>
                        {{(index $result "metrics_avg"  $metric) }}
                     </td>
                     {{ end }}
                  </tr>
               </div>
            {{end}}    
      {{end}} 
      {{end}}
      </table>
   </div>
   {{end}}
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/4.9.3/js/tabulator.min.js" integrity="sha512-N/WbW5rCM/O+/QpzuqYXkInRdSfFu6txbJcbQioBywGXDiF1XCJY2LXVKIGjNFUMS4P79mtf9pDu5ViXaa+BnA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/4.9.3/css/bootstrap/tabulator_bootstrap4.min.css" integrity="sha512-pXZ8FsuOBAyDmJ3OWob4V2UgZWQ8zs8f99MrNv0sBG8VLzuucajpzJ3BIiVNzTpfIYgzWGUq0QPJ3Y/9Gr4h7Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />

   <script>
      const datasetsInput = document.getElementById("datasets-list");
      let datasets = datasetsInput.value;
      datasets = datasets.replace("[", "");
      datasets = datasets.replace("]", "");
      datasets = datasets.replace("/", "-");
      datasets = datasets.split(" ");

      const select = document.createElement("select");
      select.value = datasets[0];
      select.style = "margin:0 0 1em; width:200px; padding: 3px; border-radius: 5px; border: #4169e1 solid 2px !important; outline: 0 !important; background: #fff;";
      select.onchange = ()=>{
        datasets.forEach((d,i) => {
         const dataset = document.getElementById("data-table-"+i);
         dataset.setAttribute("style", "height: 0; overflow: hidden;");
         if( d == select.value){
            dataset.setAttribute("style", "heigh:auto;");
         }
        })
      }
      datasets.forEach((d,i) => {
         if(i!=0){
            const dataset = document.getElementById("data-table-"+i);
            dataset.setAttribute("style", "height: 0; overflow: hidden;");
         }

         const e = document.createElement("option");
         e.value = d;
         e.innerText = d;
         select.appendChild(e);
      })
      const main = document.getElementById("content");
      main.insertBefore(select, main.firstChild)

      const datasetLabel = document.createElement("div");
      datasetLabel.innerText = "Select a dataset:";
      main.insertBefore(datasetLabel, select)


      datasets.forEach((d,i) => {

         let table = new Tabulator("#data-table-"+i, {
            layout:"fitColumns",
            movableColumns: true
         });
         let formattedColumns = table.getColumnDefinitions().map(c => { c.formatter = "html"; return c})
         
         formattedColumns.forEach((col,i) => {
            col.headerFilter = true;
            if(i>1) {
               col.formatter = "money";
               col.widthGrow = 1;

               col.hozAlign = "center";
               col.formatterParams = {
                  precision:3,
               };
               col.headerFilter = false;
            }else{
               col.widthGrow = 4;
            }
         })
         table.setColumns(formattedColumns)
      });
   </script>
</div>

{{ range $file, $result := $.Site.Data.results }}
<div class="modal modal-xl fade" id="{{$file}}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
   <div class="modal-dialog">
      <div class="modal-content">
         <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">{{$file | humanize}}</h5>
            <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
               <span aria-hidden="true">&times;</span>
            </button>
         </div>
         <div class="modal-body">
                  {{ range $k, $v := $result}}
                  <p>
                     <strong>{{$k}}</strong>
               <pre>{{jsonify (dict "indent" " ") $v}}</pre>
                  </p>
                  {{end}}
         </div>
      </div>
   </div>
</div>
{{end}}
</div>
